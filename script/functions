# -*-Shell-script-*-
#
# functions This file contains functions to be used by most or all
#           shell scripts in the tool runner scripts.
#

originating_system=`tr -d '\n' < /etc/originating_system`
originating_system_version=`tr -d '\n' < /etc/originating_system_version`
cwd=$(dirname $0)
name=`echo "$cwd" | cut -d/ -f4`
version=`echo "$cwd" | cut -d/ -f5`
common_name="$originating_system $originating_system_version $name $version"
csd=$(dirname "${BASH_SOURCE[0]}")
push_cmd="$csd/push_file.py"
current_date=$(date +%F)
history_path="$HOME/Application Execution Historyi/$current_date"
api_key="$HOME/mytardis.key"

log_start() {
  start_ts=`date +"%F %T"`
  start_file_name="$start_ts ${common_name}.start"
  timing_file_name="$start_ts ${common_name}.timing"
  stdio_file_name="$start_ts ${common_name}.stdio"
  stderr_file_name="$start_ts ${common_name}.stderr"
  export start_file_name timing_file_name stdio_file_name stderr_file_name
  
  for i in "$start_file_name" "$timing_file_name" "$stdio_file_name" "$stderr_file_name"
  do
    touch "$i"
  done
}

log_stop() {
  stop_ts=`date +"%F %T"`
  stop_file_name="$stop_ts ${common_name}.stop"
  touch "$stop_file_name"
  check_api_key

  for i in "$start_file_name" "$timing_file_name" "$stdio_file_name" "$stderr_file_name" "$stop_file_name"
  do
    python $push_cmd $api_key "Application Execution History" "$current_date" "$i"
  done
}

check_api_key() {
  if [ ! -f $api_key ]
  then
    echo -ne "MyTARDIS key file: "
    read key_file
    cp $key_file $api_key
  fi
}
